(function(a,b){"use strict";a.foresight=a.foresight||{};var c=a.foresight;c.devicePixelRatio=a.devicePixelRatio&&a.devicePixelRatio>1?a.devicePixelRatio:1;c.availWidth=a.screen.availWidth;c.availHeight=a.screen.availHeight;c.isHighSpeedConn=false;c.connKbps=0;c.connTestMethod=undefined;c.log=[],c.images=[];c.options=c.options||{};var d=c.options;d.imgClassName=d.imgClassName||"responsive-img";d.srcModification=d.srcModification||"rebuildSrc";d.srcFormat=d.srcFormat||"{protocol}://{host}{directory}{file}";d.testConn=d.testConn||true;d.minKbpsForHighSpeedConn=d.minKbpsForHighSpeedConn||800;d.speedTestUri=d.speedTestUri||"//foresightjs.appspot.com/speed-test/100K.jpg";d.speedTestKB=d.speedTestKB||100;d.speedTestExpireMinutes=d.speedTestExpireMinutes||30;d.maxImgWidth=d.maxImgWidth||1200;d.maxImgHeight=d.maxImgHeight||d.maxImgWidth;d.maxImgRequestWidth=d.maxImgRequestWidth||2048;d.maxImgRequestHeight=d.maxImgRequestHeight||d.maxImgRequestWidth;d.forcedPixelRatio=d.forcedPixelRatio;d.debug=d.debug||false;var e,f,g="loading",h="complete",i="foresight.js",j=function(){if(e)return;v("initElementIteration");e=g;var a,c;for(a=0;a<b.images.length;a++){c=b.images[a];if(c.className.indexOf(d.imgClassName)>-1){m(c)}}e=h;p()},k=function(){v("initSpeedTest");if(f)return;if(c.devicePixelRatio==1){c.connTestMethod="skip";f=h;return}try{var a=JSON.parse(localStorage.getItem(i));if(a&&a.isHighSpeedConn){var e=((new Date).getTime()-a.timestamp)/1e3/60;if(e<d.speedTestExpireMinutes){c.isHighSpeedConn=true;c.connKbps=a.connKbps;c.connTestMethod="localStorage";f=h;return}}}catch(j){}var k=b.createElement("img"),m,n,o;k.onload=function(){m=(new Date).getTime();var a=u((m-n)/1e3);a=a>1?a:1;var b=d.speedTestKB*1024*8;c.connKbps=u(b/a)/1024;c.isHighSpeedConn=c.connKbps>=d.minKbpsForHighSpeedConn;l("network")};k.onerror=function(){l("networkError")};n=(new Date).getTime();f=g;k.src=d.speedTestUri+"?r="+Math.random();o=d.speedTestKB*8/d.minKbpsForHighSpeedConn*1e3+250;setTimeout(function(){l("networkSlow")},o)},l=function(a){if(f===h)return;v("speedTestComplete: "+a);c.connTestMethod=a;try{var b={connKbps:c.connKbps,isHighSpeedConn:c.isHighSpeedConn,timestamp:(new Date).getTime()};localStorage.setItem(i,JSON.stringify(b))}catch(d){}f=h;p()},m=function(a){v("setImage");n(a,"src","orgSrc");a.orgWidth=a.width;a.orgHeight=a.height;if(!a.orgSrc||!a.width||!a.height)return;n(a,"max-width","maxWidth",true,d.maxImgWidth);n(a,"max-height","maxHeight",true,d.maxImgHeight);n(a,"max-request-width","maxRequestWidth",true,d.maxImgRequestWidth);n(a,"max-request-height","maxRequestHeight",true,d.maxImgRequestHeight);n(a,"win-width-percent","winWidthPercent",true,0);n(a,"win-height-percent","winHeightPercent",true,0);o(a);q(a,"width","maxWidth","height","maxHeight");n(a,"src-modification","srcModification",false,d.srcModification);n(a,"src-format","srcFormat",false,d.srcFormat);n(a,"pixel-ratio","pixelRatio",true,c.devicePixelRatio);c.images.push(a)},n=function(a,b,c,d,e){var f=a.getAttribute("data-"+b);if(f&&f!==""){if(d){f=f.replace("%","");if(!isNaN(f)){f=parseFloat(f,10)}}}else{f=e}a[c]=f},o=function(a){if(a.winWidthPercent>0){var b=a.width;a.width=u(a.winWidthPercent/100*c.availWidth);a.height=u(a.height*(a.width/b))}else if(a.winHeightPercent>0){var d=a.height;a.height=u(a.winHeightPercent/100*c.availHeight);a.width=u(a.width*(a.height/d))}},p=function(){v("initImageRebuild");if(f===h&&e===h){var a,b;for(a=0;a<c.images.length;a++){b=c.images[a];b.requestWidth=u(b.width*b.pixelRatio);b.requestHeight=u(b.height*b.pixelRatio);q(b,"requestWidth","maxRequestWidth","requestHeight","maxRequestHeight");if(b.srcModification==="rebuildSrc"&&b.srcFormat){r(b)}else{t(b)}}if(c.oncomplete){c.oncomplete()}}},q=function(a,b,c,d,e){var f;if(a[b]>a[c]){f=a[b];a[b]=a[c];a[d]=u(a[d]*(a[b]/f))}if(a[d]>a[e]){f=a[d];a[d]=a[e];a[b]=u(a[b]*(a[d]/f));if(a[b]>a[c]){f=a.img[b];a[b]=a[c];a[d]=u(a[d]*(a[b]/f))}}},r=function(a){var b,c=["protocol","host","port","directory","file","filename","ext","query","requestWidth","requestHeight","pixelRatio"],d=a.srcFormat;a.uri=s(a.orgSrc);a.uri.requestWidth=a.requestWidth;a.uri.requestHeight=a.requestHeight;a.uri.pixelRatio=a.pixelRatio;for(b=0;b<c.length;b++){d=d.replace("{"+c[b]+"}",a.uri[c[b]])}a.src=d},s=function(a){var b={key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},c=b.parser.exec(a),d={},e=14;while(e--)d[b.key[e]]=c[e]||"";d[b.q.name]={};d[b.key[12]].replace(b.q.parser,function(a,c,e){if(c)d[b.q.name][c]=e});var f=d.file.split(".");d.filename=f[0];d.ext=f.length>1?f[f.length-1]:"";return d},t=function(a){a.src=a.orgSrc.replace(a.orgWidth,a.requestWidth).replace(a.orgHeight,a.requestHeight)},u=function(a){return Math.round(a)},v=function(a){if(!d.debug)return;var b=new Date;a+=" -- "+b.getMinutes()+":"+b.getSeconds()+":"+b.getMilliseconds();c.log.push(a)};if(d.forcedPixelRatio){c.devicePixelRatio=d.forcedPixelRatio}if(b.readyState===h){v("document.readyState === STATUS_COMPLETE");j()}else{if(b.addEventListener){v("document.addEventListener");b.addEventListener("DOMContentLoaded",j,false);a.addEventListener("load",j,false)}else if(b.attachEvent){v("document.attachEvent");b.attachEvent("onreadystatechange",j);a.attachEvent("onload",j)}}k()})(this,document)